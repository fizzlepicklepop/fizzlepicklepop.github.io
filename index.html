<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dynamic Data List - Dark Mode</title>
  <style>
    /* Dark mode styles with background image */
    body {
      font-family: Arial, sans-serif;
      background: url('data/assets/background.png') no-repeat center center fixed;
      background-size: cover;
      color: #e0e0e0;
      margin: 0;
      padding: 20px;
    }
    /* Container with semi-transparent overlay for readability */
    .container {
      max-width: 900px;
      margin: 0 auto;
      background-color: rgba(0, 0, 0, 0.5);
      padding: 20px;
      border-radius: 8px;
    }
    /* Card style for each list entry */
    .card {
      background-color: #1e1e1e;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      padding: 15px;
    }
    .card img {
      max-width: 120px;
      border-radius: 4px;
      margin-right: 20px;
    }
    .card-content {
      flex: 1;
    }
    .card-title {
      font-size: 1.5em;
      margin: 0;
      color: #ffffff;
    }
    .card a {
      text-decoration: none;
      color: #bb86fc;
      font-weight: bold;
    }
    .card-links a {
      margin-right: 15px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="file-list"></div>
  </div>
  
  <script>
    // *** Configuration ***
    const GITHUB_USERNAME = "fizzlepicklepop";
    const GITHUB_REPO = "fizzlepicklepop.github.io";
    
    // Folder paths:
    const MAPS_FOLDER = "data/maps";
    const GAMETYPES_FOLDER = "data/gametypes";
    const ASSETS_FOLDER = "data/assets";
    
    // API endpoints:
    const MAPS_API_URL = `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${MAPS_FOLDER}`;
    const GAMETYPES_API_URL = `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${GAMETYPES_FOLDER}`;
    const PLACEHOLDER_API_URL = `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${ASSETS_FOLDER}/placeholder.png`;
    
    // Helper function to fetch text from a given URL.
    async function fetchText(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error("Network response was not ok for " + url);
      return res.text();
    }
    
    async function loadFiles() {
      try {
        // Fetch the placeholder image info.
        let placeholderDownloadURL = "";
        const placeholderResponse = await fetch(PLACEHOLDER_API_URL);
        if (placeholderResponse.ok) {
          const placeholderData = await placeholderResponse.json();
          placeholderDownloadURL = placeholderData.download_url;
        } else {
          console.error("Failed to fetch placeholder image from:", PLACEHOLDER_API_URL);
        }
        
        // Fetch files from the maps folder.
        const mapsResponse = await fetch(MAPS_API_URL);
        if (!mapsResponse.ok) {
          throw new Error("Failed to fetch maps folder from: " + MAPS_API_URL);
        }
        const mapFiles = await mapsResponse.json();
        console.log("Map Files:", mapFiles);
        
        // Fetch files from the gametypes folder.
        const gametypesResponse = await fetch(GAMETYPES_API_URL);
        if (!gametypesResponse.ok) {
          throw new Error("Failed to fetch gametypes folder from: " + GAMETYPES_API_URL);
        }
        const gametypesFiles = await gametypesResponse.json();
        console.log("Gametypes Files:", gametypesFiles);
        
        // Build a dictionary for gametypes files keyed by filename.
        const gametypesDict = {};
        gametypesFiles.forEach(file => {
          gametypesDict[file.name] = file;
        });
        
        // Group files from the maps folder by their base name.
        const groups = {};
        mapFiles.forEach(file => {
          const parts = file.name.split('.');
          if (parts.length < 2) return;  // Skip files with no extension.
          const ext = parts.pop().toLowerCase();
          const base = parts.join('.');
          if (!groups[base]) groups[base] = {};
          groups[base][ext] = file;
        });
        console.log("Grouped Files:", groups);
        
        const fileListContainer = document.getElementById("file-list");
        
        // For each group that includes an .mvar file, build a card.
        let foundItem = false;
        for (const base in groups) {
          if (!groups[base].mvar) continue; // Only process groups with an .mvar file.
          
          foundItem = true;
          const group = groups[base];
          const card = document.createElement("div");
          card.className = "card";
          
          // Add thumbnail: use the .png if available, otherwise use the placeholder.
          const img = document.createElement("img");
          if (group.png) {
            img.src = group.png.download_url;
          } else {
            img.src = placeholderDownloadURL;
          }
          img.alt = base;
          card.appendChild(img);
          
          const contentDiv = document.createElement("div");
          contentDiv.className = "card-content";
          
          // Title derived from the base name.
          const title = document.createElement("h2");
          title.className = "card-title";
          title.textContent = base;
          contentDiv.appendChild(title);
          
          // Create container for download links.
          const linksDiv = document.createElement("div");
          linksDiv.className = "card-links";
          
          // Download link for the .mvar file.
          const mvarLink = document.createElement("a");
          mvarLink.href = group.mvar.download_url;
          mvarLink.textContent = "Download .mvar";
          mvarLink.download = group.mvar.name;
          mvarLink.style.marginRight = "10px";
          linksDiv.appendChild(mvarLink);
          
          // If a .txt file exists, use its first line to look up a gametype file.
          if (group.txt) {
            const gametypeLink = document.createElement("a");
            gametypeLink.textContent = "Download Gametype";
            fetchText(group.txt.download_url).then(text => {
              const firstLine = text.split('\n')[0].trim();
              if (gametypesDict[firstLine]) {
                gametypeLink.href = gametypesDict[firstLine].download_url;
                gametypeLink.download = gametypesDict[firstLine].name;
              } else {
                gametypeLink.textContent = "Gametype file not found";
                gametypeLink.href = "#";
              }
            }).catch(err => {
              console.error("Error fetching .txt for", base, err);
              gametypeLink.textContent = "Error loading gametype file";
            });
            linksDiv.appendChild(gametypeLink);
          }
          
          contentDiv.appendChild(linksDiv);
          card.appendChild(contentDiv);
          fileListContainer.appendChild(card);
        }
        
        if (!foundItem) {
          fileListContainer.textContent = "No .mvar files found in the maps folder.";
        }
      } catch (error) {
        console.error("Error loading files:", error);
        document.getElementById("file-list").textContent = "Error loading files.";
      }
    }
    
    // Run the function to load files when the page loads.
    loadFiles();
  </script>
</body>
</html>
