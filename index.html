<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Glassy Aero Data List</title>
  <style>
    /* Glassy aero style for the background */
    body {
      font-family: Arial, sans-serif;
      background: url('data/assets/background.png') no-repeat center center fixed;
      background-size: cover;
      color: #fff;
      margin: 0;
      padding: 20px;
    }
    
    /* Fixed sidebar on the left */
    .sidebar {
      position: fixed;
      left: 20px;
      top: 20px;
      width: 220px;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 10px;
      padding: 20px;
      z-index: 1000;
    }
    .sidebar ul {
      list-style-type: none;
      padding: 0;
      margin: 0;
    }
    .sidebar li {
      margin-bottom: 15px;
    }
    .sidebar a {
      color: #fff;
      text-decoration: none;
      font-size: 1.1em;
      padding: 8px;
      display: block;
      border-radius: 5px;
      background: rgba(255, 255, 255, 0.1);
    }
    .sidebar a.active,
    .sidebar a:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    /* Content area with a left margin to avoid overlap with the sidebar */
    .content {
      margin-left: 260px; /* Sidebar width (220px) + extra margin */
      padding: 20px;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 10px;
    }
    
    /* Card style for each list entry (glassy style) */
    .card {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 10px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      padding: 15px;
    }
    .card img {
      max-width: 120px;
      border-radius: 4px;
      margin-right: 20px;
    }
    .card-content {
      flex: 1;
    }
    .card-title {
      font-size: 1.5em;
      margin: 0;
      color: #fff;
    }
    .card-description {
      margin: 10px 0;
      color: #e0e0e0;
    }
    .card a {
      text-decoration: none;
      color: #bb86fc;
      font-weight: bold;
    }
    .card-links a {
      margin-right: 15px;
    }
  </style>
</head>
<body>
  <!-- Fixed Sidebar -->
  <div class="sidebar">
    <ul>
      <li><a href="#" data-category="all" class="active">All</a></li>
      <li><a href="#" data-category="halor">Halo Reach</a></li>
      <li><a href="#" data-category="halo2a">Halo 2 Anniversary</a></li>
      <li><a href="#" data-category="halo3">Halo 3</a></li>
      <li><a href="#" data-category="halo4">Halo 4</a></li>
    </ul>
  </div>
  
  <!-- Content Area -->
  <div class="content">
    <div id="file-list"></div>
  </div>
  
  <script>
    const GITHUB_USERNAME = "fizzlepicklepop";
    const GITHUB_REPO = "fizzlepicklepop.github.io";
    const ASSETS_FOLDER = "data/assets";
    
    let currentCategory = "all";
    
    // Main loader: routes to the appropriate loader based on the category.
    function loadFiles(category) {
      currentCategory = category;
      if (category === "all") {
        loadAllFiles();
      } else {
        loadCategoryFiles(category);
      }
    }
    
    // Loader for a specific category.
    async function loadCategoryFiles(category) {
      const MAPS_API_URL = `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/data/${category}/maps`;
      const GAMETYPES_API_URL = `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/data/${category}/gametypes`;
      const PLACEHOLDER_API_URL = `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${ASSETS_FOLDER}/placeholder.png`;
      
      async function fetchText(url) {
        const res = await fetch(url);
        if (!res.ok) throw new Error("Network response was not ok for " + url);
        return res.text();
      }
      
      try {
        // Fetch placeholder image.
        let placeholderDownloadURL = "";
        const placeholderResponse = await fetch(PLACEHOLDER_API_URL);
        if (placeholderResponse.ok) {
          const placeholderData = await placeholderResponse.json();
          placeholderDownloadURL = placeholderData.download_url;
        } else {
          console.error("Failed to fetch placeholder image from:", PLACEHOLDER_API_URL);
        }
        
        // Fetch maps and gametypes.
        const mapsResponse = await fetch(MAPS_API_URL);
        if (!mapsResponse.ok) throw new Error("Failed to fetch maps from: " + MAPS_API_URL);
        const mapFiles = await mapsResponse.json();
        
        const gametypesResponse = await fetch(GAMETYPES_API_URL);
        if (!gametypesResponse.ok) throw new Error("Failed to fetch gametypes from: " + GAMETYPES_API_URL);
        const gametypesFiles = await gametypesResponse.json();
        
        // Build gametypes dictionary.
        const gametypesDict = {};
        gametypesFiles.forEach(file => { gametypesDict[file.name] = file; });
        
        // Group map files by base name.
        const groups = {};
        mapFiles.forEach(file => {
          const parts = file.name.split('.');
          if (parts.length < 2) return;
          const ext = parts.pop().toLowerCase();
          const base = parts.join('.');
          if (!groups[base]) groups[base] = {};
          groups[base][ext] = file;
        });
        
        const fileListContainer = document.getElementById("file-list");
        fileListContainer.innerHTML = "";
        let foundItem = false;
        for (const base in groups) {
          if (!groups[base].mvar) continue;
          foundItem = true;
          const group = groups[base];
          const card = document.createElement("div");
          card.className = "card";
          
          const img = document.createElement("img");
          img.src = group.png ? group.png.download_url : placeholderDownloadURL;
          img.alt = base;
          card.appendChild(img);
          
          const contentDiv = document.createElement("div");
          contentDiv.className = "card-content";
          
          const title = document.createElement("h2");
          title.className = "card-title";
          title.textContent = base;
          contentDiv.appendChild(title);
          
          const linksDiv = document.createElement("div");
          linksDiv.className = "card-links";
          
          const mvarLink = document.createElement("a");
          mvarLink.href = group.mvar.download_url;
          mvarLink.textContent = "Download .mvar";
          mvarLink.download = group.mvar.name;
          mvarLink.style.marginRight = "10px";
          linksDiv.appendChild(mvarLink);
          
          if (group.txt) {
            fetchText(group.txt.download_url).then(text => {
              const lines = text.split('\n');
              const gametypeFilename = lines[0].trim();
              if (lines.length > 1) {
                const descriptionText = lines.slice(1).join('\n').trim();
                if (descriptionText) {
                  const descElem = document.createElement("p");
                  descElem.className = "card-description";
                  descElem.textContent = descriptionText;
                  contentDiv.insertBefore(descElem, linksDiv);
                }
              }
              const gametypeLink = document.createElement("a");
              gametypeLink.textContent = "Download Gametype";
              if (gametypesDict[gametypeFilename]) {
                gametypeLink.href = gametypesDict[gametypeFilename].download_url;
                gametypeLink.download = gametypesDict[gametypeFilename].name;
              } else {
                gametypeLink.textContent = "Gametype file not found";
                gametypeLink.href = "#";
              }
              linksDiv.appendChild(gametypeLink);
            }).catch(err => {
              console.error("Error fetching .txt for", base, err);
              const gametypeLink = document.createElement("a");
              gametypeLink.textContent = "Error loading gametype file";
              linksDiv.appendChild(gametypeLink);
            });
          }
          
          contentDiv.appendChild(linksDiv);
          card.appendChild(contentDiv);
          fileListContainer.appendChild(card);
        }
        if (!foundItem) {
          fileListContainer.textContent = "No .mvar files found in the maps folder.";
        }
      } catch (error) {
        console.error("Error loading category files:", error);
        document.getElementById("file-list").textContent = "Error loading files: " + error.message;
      }
    }
    
    // Loader for "All": lists every .mvar and .bin file from all subfolders.
    async function loadAllFiles() {
      const categories = ["halor", "halo2a", "halo3", "halo4"];
      try {
        const fetchPromises = categories.map(cat => {
          const apiUrl = `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/data/${cat}/maps`;
          return fetch(apiUrl)
            .then(response => {
              if (!response.ok) throw new Error("Failed to fetch from " + apiUrl);
              return response.json();
            })
            .then(files => {
              files.forEach(file => file.category = cat);
              return files;
            });
        });
        const results = await Promise.all(fetchPromises);
        const allFiles = results.flat();
        const filteredFiles = allFiles.filter(file => {
          const ext = file.name.split('.').pop().toLowerCase();
          return ext === "mvar" || ext === "bin";
        });
        const fileListContainer = document.getElementById("file-list");
        fileListContainer.innerHTML = "";
        if (filteredFiles.length === 0) {
          fileListContainer.textContent = "No .mvar or .bin files found in all subfolders.";
        } else {
          filteredFiles.forEach(file => {
            const card = document.createElement("div");
            card.className = "card";
            const contentDiv = document.createElement("div");
            contentDiv.className = "card-content";
            
            const title = document.createElement("h2");
            title.className = "card-title";
            const parts = file.name.split('.');
            const baseName = parts.slice(0, -1).join('.');
            title.textContent = baseName;
            contentDiv.appendChild(title);
            
            const sourceInfo = document.createElement("p");
            sourceInfo.className = "card-description";
            let sourceText = "";
            switch(file.category) {
              case "halor": sourceText = "Halo Reach"; break;
              case "halo2a": sourceText = "Halo 2 Anniversary"; break;
              case "halo3": sourceText = "Halo 3"; break;
              case "halo4": sourceText = "Halo 4"; break;
              default: sourceText = file.category;
            }
            sourceInfo.textContent = "Source: " + sourceText;
            contentDiv.appendChild(sourceInfo);
            
            const linksDiv = document.createElement("div");
            linksDiv.className = "card-links";
            const fileLink = document.createElement("a");
            fileLink.href = file.download_url;
            const ext = file.name.split('.').pop().toUpperCase();
            fileLink.textContent = "Download " + ext;
            fileLink.download = file.name;
            linksDiv.appendChild(fileLink);
            
            contentDiv.appendChild(linksDiv);
            card.appendChild(contentDiv);
            fileListContainer.appendChild(card);
          });
        }
      } catch (error) {
        console.error("Error loading all files:", error);
        document.getElementById("file-list").textContent = "Error loading files: " + error.message;
      }
    }
    
    // Sidebar event handling.
    document.querySelectorAll(".sidebar a").forEach(link => {
      link.addEventListener("click", function(e) {
        e.preventDefault();
        document.querySelectorAll(".sidebar a").forEach(l => l.classList.remove("active"));
        this.classList.add("active");
        const selectedCategory = this.getAttribute("data-category");
        loadFiles(selectedCategory);
      });
    });
    
    // Initial load.
    loadFiles(currentCategory);
  </script>
</body>
</html>
