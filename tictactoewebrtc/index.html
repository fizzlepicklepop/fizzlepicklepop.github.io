<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>P2P Tic-Tac-Toe (y-webrtc)</title>
<style>
  body { font-family: sans-serif; background: #e0f7fa; margin: 0; padding: 0; }
  .wrap { max-width: 800px; margin: auto; padding: 16px; }
  header { display: flex; justify-content: space-between; align-items: center; }
  .view { display: none; }
  .view.active { display: block; }
  .card { background: white; padding: 16px; border-radius: 8px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  .row { display: flex; gap: 8px; flex-wrap: wrap; }
  .btn { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; }
  .primary { background: #00796b; color: white; }
  .info { background: #0288d1; color: white; }
  .pill { background: #b2ebf2; padding: 4px 8px; border-radius: 12px; }
  .muted { color: #666; }
  .grid { display: grid; grid-template-columns: repeat(3, 80px); gap: 4px; justify-content: center; }
  .cell { width: 80px; height: 80px; font-size: 2rem; }
  #connectionLog { font-size: 0.9rem; background: #f1f8e9; padding: 8px; border-radius: 4px; max-height: 120px; overflow-y: auto; }
</style>
</head>
<body>
<div class="wrap">
<header>
  <h1>P2P Tic-Tac-Toe</h1>
  <div class="pill" id="statusText">Not connected</div>
</header>
<section id="view-lobby" class="view active">
  <div class="card">
    <div class="row">
      <input id="username" placeholder="Username" />
      <input id="room" placeholder="Room name" />
    </div>
    <div class="row">
      <button id="create" class="btn primary">Create Room</button>
      <button id="join" class="btn info">Join Room</button>
    </div>
  </div>
</section>
<section id="view-game" class="view">
  <div class="card">
    <div class="row">
      <button id="leave" class="btn">Leave</button>
      <div class="pill">You: <span id="you">—</span></div>
      <div class="pill">Mark: <span id="mark">—</span></div>
      <div class="pill">Turn: <span id="turn">—</span></div>
    </div>
  </div>
  <div class="card">
    <div class="grid" id="board"></div>
  </div>
  <div class="card">
    <div class="muted">Connection log:</div>
    <div id="connectionLog"></div>
  </div>
</section>
</div>
<script type="module">
import * as Y from 'https://cdn.jsdelivr.net/npm/yjs@13.6.15/dist/yjs.mjs';
import { WebrtcProvider } from 'https://cdn.jsdelivr.net/npm/y-webrtc@10.3.2/dist/y-webrtc.mjs';

const statusText = document.getElementById('statusText');
const connectionLog = document.getElementById('connectionLog');
function log(msg) {
  const time = new Date().toLocaleTimeString();
  connectionLog.innerHTML += `<div>[${time}] ${msg}</div>`;
  connectionLog.scrollTop = connectionLog.scrollHeight;
}

const lobbyView = document.getElementById('view-lobby');
const gameView = document.getElementById('view-game');
function flipTo(view) {
  lobbyView.classList.remove('active');
  gameView.classList.remove('active');
  document.getElementById(`view-${view}`).classList.add('active');
}

const usernameIn = document.getElementById('username');
const roomInput = document.getElementById('room');
const createBtn = document.getElementById('create');
const joinBtn = document.getElementById('join');
const leaveBtn = document.getElementById('leave');
const youEl = document.getElementById('you');
const markEl = document.getElementById('mark');
const turnEl = document.getElementById('turn');
const boardEl = document.getElementById('board');

let provider, game, board, myMark;
const cells = [];
for (let i = 0; i < 9; i++) {
  const b = document.createElement('button');
  b.className = 'cell';
  b.addEventListener('click', () => doMove(i));
  boardEl.appendChild(b);
  cells.push(b);
}

function start(room, username) {
  flipTo('game');
  log(`Joining room '${room}' as ${username}...`);
  const ydoc = new Y.Doc();
  provider = new WebrtcProvider(room, ydoc, {
    signaling: ['wss://signaling.yjs.dev'],
  });
  provider.awareness.setLocalStateField('user', { name: username });
  statusText.textContent = 'Connecting...';

  provider.on('status', e => {
    statusText.textContent = e.status === 'connected' ? 'Connected' : 'Connecting...';
    log(`Status: ${e.status}`);
  });
  provider.on('peers', e => {
    log(`Peers changed: ${JSON.stringify(e)}`);
  });

  game = ydoc.getMap('game');
  if (!game.has('board')) game.set('board', new Y.Array());
  board = game.get('board');
  if (board.length === 0) board.insert(0, Array(9).fill(null));
  game.observeDeep(render);
  render();

  myMark = 'X';
  youEl.textContent = username;
  markEl.textContent = myMark;
}

function render() {
  if (!board) return;
  const b = board.toArray()[0] || Array(9).fill(null);
  cells.forEach((c, i) => c.textContent = b[i] || '');
}

function doMove(i) {
  const b = board.toArray()[0];
  if (b[i]) return;
  b[i] = myMark;
  board.delete(0,1);
  board.insert(0, [b]);
}

createBtn.onclick = () => {
  if (!usernameIn.value.trim() || !roomInput.value.trim()) {
    alert('Enter username and room');
    return;
  }
  start(roomInput.value.trim(), usernameIn.value.trim());
};
joinBtn.onclick = createBtn.onclick;
leaveBtn.onclick = () => location.reload();
</script>
</body>
</html>
