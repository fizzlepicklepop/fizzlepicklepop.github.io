<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tic‚ÄëTac‚ÄëToe ‚Äî P2P (y‚Äëwebrtc, no signup)</title>
  <style>
    /* ======================= THEME ======================= */
    :root {
      --bg: #0b1020; --bg2:#0e1530; --card:#121a33; --muted:#94a3ff; --text:#eaf0ff; --accent:#6ae6b3; --accent-2:#7ad1ff; --danger:#ff7a7a; --ring: rgba(122, 209, 255, .5);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    [data-theme="light"]{
      --bg:#f6f7fb; --bg2:#eef1ff; --card:#ffffff; --muted:#5563c1; --text:#0e1330; --accent:#14b8a6; --accent-2:#2563eb; --danger:#ef4444; --ring: rgba(37, 99, 235, .28);
      --shadow: 0 8px 24px rgba(5,16,60,.12);
    }
    html, body { height:100%; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial; background: radial-gradient(1200px 700px at 20% -10%, var(--bg2), var(--bg)); color:var(--text); overflow-x:hidden; }

    /* ======================= BUBBLY BACKGROUND ======================= */
    .bg { position: fixed; inset: -10vmax; z-index: -1; filter: blur(40px); pointer-events:none; }
    .blob { position: absolute; width: 40vmax; height: 40vmax; border-radius: 50%; opacity:.45; mix-blend-mode: screen; animation: float 18s ease-in-out infinite alternate; }
    .blob1 { left: -8vmax; top: -8vmax; background: radial-gradient(circle at 30% 30%, var(--accent), transparent 60%); animation-duration: 20s; }
    .blob2 { right: -10vmax; bottom: -12vmax; background: radial-gradient(circle at 70% 70%, var(--accent-2), transparent 60%); animation-duration: 22s; }
    @keyframes float { from { transform: translate3d(0,0,0) scale(1);} to { transform: translate3d(4vmax,-3vmax,0) scale(1.08);} }
    @media (prefers-reduced-motion: reduce){ .blob{ animation:none; } }

    /* ======================= LAYOUT ======================= */
    .wrap { max-width: 980px; margin: 0 auto; padding: 28px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom: 20px; }
    h1 { font-size: clamp(22px, 3.2vw, 36px); letter-spacing: .3px; margin:0; display:flex; align-items:center; gap:8px; }
    .card { background: linear-gradient(180deg, color-mix(in oklab, var(--card), transparent 90%), color-mix(in oklab, var(--card), transparent 80%)); border:1px solid color-mix(in oklab, var(--text), transparent 92%); border-radius: 22px; padding: 18px; box-shadow: var(--shadow); backdrop-filter: saturate(140%) blur(4px); }

    .row { display:flex; gap:12px; flex-wrap: wrap; align-items:center; }
    .input { flex:1 1 220px; min-width: 200px; padding: 12px 14px; border-radius: 16px; outline:none; border:1px solid color-mix(in oklab, var(--text), transparent 88%); background: color-mix(in oklab, var(--bg2), white 5%); color:var(--text); font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono"; box-shadow: inset 0 0 0 1px transparent; transition: box-shadow .15s ease, transform .06s ease; }
    .input:focus { box-shadow: 0 0 0 6px var(--ring); transform: translateY(-1px); }

    .btn { padding: 11px 14px; border-radius: 16px; border:1px solid color-mix(in oklab, var(--text), transparent 90%); background: linear-gradient(180deg, color-mix(in oklab, var(--bg2), white 8%), color-mix(in oklab, var(--bg2), black 6%)); color:var(--text); cursor:pointer; font-weight:700; letter-spacing:.2px; transition: transform .06s ease, box-shadow .15s ease, opacity .2s; box-shadow: 0 6px 16px rgba(0,0,0,.12); }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 10px 22px rgba(0,0,0,.16); }
    .btn:active { transform: translateY(0); }
    .btn:disabled { opacity:.55; cursor:not-allowed; }
    .btn.primary { background: linear-gradient(180deg, color-mix(in oklab, var(--accent-2), white 6%), color-mix(in oklab, var(--accent-2), black 10%)); color:white; border-color: transparent; }
    .btn.ghost { background: transparent; }

    .pill { display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius: 999px; font-size:12px; border:1px solid color-mix(in oklab, var(--text), transparent 90%); background: color-mix(in oklab, var(--bg2), white 4%); box-shadow: var(--shadow); }
    .muted { color: color-mix(in oklab, var(--text), white 40%); }

    /* ======================= BOARD ======================= */
    .grid { display:grid; grid-template-columns: repeat(3, minmax(90px, 120px)); grid-template-rows: repeat(3, minmax(90px, 120px)); gap: 12px; justify-content:center; margin-top:12px; }
    .cell { display:flex; align-items:center; justify-content:center; font-weight:900; font-size:64px; background: var(--card); border-radius: 22px; border: 1px solid color-mix(in oklab, var(--text), transparent 90%); cursor:pointer; user-select:none; transition: transform .08s ease, background .2s ease, box-shadow .15s ease; box-shadow: 0 8px 20px rgba(0,0,0,.15); }
    .cell:hover { transform: translateY(-1px) scale(1.01); box-shadow: 0 12px 26px rgba(0,0,0,.18); }
    .cell:disabled { cursor:not-allowed; opacity:.6; }
    .cell.placed { animation: pop .24s cubic-bezier(.2,.8,.2,1); }
    @keyframes pop { 0%{ transform: scale(.75); filter: saturate(1.2);} 60%{ transform: scale(1.1);} 100%{ transform: scale(1);} }

    footer { opacity:.8; font-size:12px; margin-top:16px; text-align:center; }

    /* Theme toggle icon styles */
    .toggle { display:flex; align-items:center; gap:8px; padding:8px 12px; border-radius:16px; border:1px solid color-mix(in oklab, var(--text), transparent 90%); background: color-mix(in oklab, var(--bg2), white 4%); cursor:pointer; box-shadow: var(--shadow); }
  </style>
</head>
<body>
  <div class="bg">
    <div class="blob blob1"></div>
    <div class="blob blob2"></div>
  </div>

  <div class="wrap">
    <header>
      <h1>üéÆ Tic‚ÄëTac‚ÄëToe ‚Äî P2P (y‚Äëwebrtc)</h1>
      <div class="row">
        <button id="themeToggle" class="toggle" title="Toggle theme">üåô <span id="themeLabel">Dark</span></button>
        <div class="pill"><span id="statusText">Not connected</span></div>
      </div>
    </header>

    <div class="card" style="margin-bottom:16px;">
      <div class="row">
        <input id="room" class="input" placeholder="Room name, e.g. tictactoe-COCO" />
        <input id="secret" class="input" placeholder="(Optional) room password" />
        <button id="join" class="btn primary">Join room</button>
        <button id="leave" class="btn" disabled>Leave</button>
      </div>
      <div class="row" style="margin-top:8px;">
        <div class="muted">Peers: <span id="peers">0</span></div>
        <div class="muted">You are: <span id="role">‚Äî</span></div>
        <div class="muted">Mark: <span id="mark">‚Äî</span></div>
        <div class="muted">Turn: <span id="turn">‚Äî</span></div>
      </div>
      <div class="muted" style="font-size:13px; margin-top:8px;">No signup, no servers you operate. Discovery via public y‚Äëwebrtc hubs; game data syncs peer‚Äëto‚Äëpeer.</div>
    </div>

    <div class="card" style="text-align:center;">
      <div class="grid" id="board"></div>
      <div class="row" style="justify-content:center; margin-top:12px;">
        <button id="reset" class="btn" disabled>Reset</button>
      </div>
    </div>

    <footer>
      Heads‚Äëup: Without TURN relays, very restrictive networks might not connect. Works great on home/Wi‚ÄëFi.
    </footer>
  </div>

  <script type="module">
    // ===== Imports (no signup; CDN modules) =====
    import * as Y from 'https://cdn.jsdelivr.net/npm/yjs@13.6.15/dist/yjs.mjs';
    import { WebrtcProvider } from 'https://cdn.jsdelivr.net/npm/y-webrtc@10.3.2/dist/y-webrtc.mjs';

    // ===== Theme toggle (persisted) =====
    const themeBtn = document.getElementById('themeToggle');
    const themeLabel = document.getElementById('themeLabel');
    const root = document.documentElement;
    const stored = localStorage.getItem('theme');
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    const initial = stored || (prefersDark ? 'dark' : 'light');
    setTheme(initial);
    themeBtn.onclick = () => setTheme(root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');

    function setTheme(mode){
      root.setAttribute('data-theme', mode);
      themeLabel.textContent = mode === 'dark' ? 'Dark' : 'Light';
      themeBtn.firstChild.nodeValue = mode === 'dark' ? 'üåô ' : '‚òÄÔ∏è ';
      localStorage.setItem('theme', mode);
    }

    // ===== UI refs =====
    const statusText = document.getElementById('statusText');
    const roomInput  = document.getElementById('room');
    const secretInput= document.getElementById('secret');
    const joinBtn    = document.getElementById('join');
    const leaveBtn   = document.getElementById('leave');
    const peersEl    = document.getElementById('peers');
    const roleEl     = document.getElementById('role');
    const markEl     = document.getElementById('mark');
    const turnEl     = document.getElementById('turn');
    const boardEl    = document.getElementById('board');
    const resetBtn   = document.getElementById('reset');

    // Build board UI
    const cells = [];
    for (let i = 0; i < 9; i++) {
      const b = document.createElement('button');
      b.className = 'cell';
      b.addEventListener('click', () => doMove(i));
      boardEl.appendChild(b);
      cells.push(b);
    }

    // ===== Yjs doc & shared state =====
    let ydoc, provider, game, board, players;
    let myMark = null; // 'X' | 'O' | null (spectator)

    function initDoc(room, password) {
      ydoc = new Y.Doc();
      // Public community hubs; no signup
      provider = new WebrtcProvider(room, ydoc, {
        signaling: [
          'wss://signaling.yjs.dev',
          'wss://y-webrtc-signaling-eu.herokuapp.com',
          'wss://y-webrtc-signaling-us.herokuapp.com'
        ],
        password: password || undefined,
      });

      game = ydoc.getMap('game');
      if (!game.has('players')) game.set('players', new Y.Map());
      if (!game.has('turn')) game.set('turn', 'X');
      if (!game.has('status')) game.set('status', 'playing');
      if (!game.has('board')) game.set('board', new Y.Array());

      players = game.get('players');
      board = game.get('board');
      if (board.length === 0) board.insert(0, Array(9).fill(null));

      // Observe changes and re-render
      game.observeDeep(() => render());

      // Awareness: update peers count
      const updatePeers = () => {
        const states = provider.awareness.getStates();
        peersEl.textContent = states.size;
      };
      provider.awareness.on('update', updatePeers);
      updatePeers();

      // Assign mark
      assignMark();

      // Update status pill
      const setConnStatus = () => {
        const connected = provider.connected; // boolean
        statusText.textContent = connected ? 'Connected' : 'Connecting‚Ä¶';
      };
      provider.on('synced', setConnStatus);
      provider.on('status', setConnStatus);
      setConnStatus();
    }

    function assignMark(){
      const me = ydoc.clientID;
      const x = players.get('X');
      const o = players.get('O');
      if (!x) { players.set('X', me); myMark = 'X'; }
      else if (x && x !== me && !o) { players.set('O', me); myMark = 'O'; }
      else if (x === me) { myMark = 'X'; }
      else if (o === me) { myMark = 'O'; }
      else { myMark = null; } // spectator if X and O already assigned
      roleEl.textContent = myMark ? (myMark === 'X' ? 'Host' : 'Guest') : 'Spectator';
      markEl.textContent = myMark || '‚Äî';
      render();
    }

    function currentTurn(){ return game.get('turn'); }
    function setTurn(t){ game.set('turn', t); }

    function winner(b){
      const lines = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
      for (const [a,b2,c] of lines) {
        if (b[a] && b[a] === b[b2] && b[a] === b[c]) return b[a];
      }
      return b.every(Boolean) ? 'draw' : null;
    }

    function doMove(i){
      if (!myMark) return; // spectators can't play
      const b = board.toArray()[0];
      if (game.get('status') !== 'playing') return;
      if (b[i]) return;
      if (currentTurn() !== myMark) return;
      const next = b.slice();
      next[i] = myMark;
      board.delete(0,1); board.insert(0, [next]);
      const w = winner(next);
      if (w) {
        game.set('status', w === 'draw' ? 'draw' : `${w}-wins`);
      } else {
        setTurn(myMark === 'X' ? 'O' : 'X');
      }
      // animate placed cell
      cells[i].classList.remove('placed');
      void cells[i].offsetWidth; // reflow to restart animation
      cells[i].classList.add('placed');
      render();
    }

    function reset(){
      if (!game) return;
      board.delete(0,1); board.insert(0, [Array(9).fill(null)]);
      game.set('status', 'playing');
      game.set('turn', 'X');
      render();
    }

    function render(){
      if (!board) return;
      const b = board.toArray()[0] || Array(9).fill(null);
      cells.forEach((c, idx) => { c.textContent = b[idx] || ''; });
      const w = winner(b);
      if (game.get('status') === 'draw' || w === 'draw') {
        turnEl.textContent = 'Draw';
      } else if (w) {
        turnEl.textContent = `${w} wins`; 
      } else {
        turnEl.textContent = `Turn: ${currentTurn()}`;
      }
      const myTurn = !!myMark && currentTurn() === myMark && !w;
      cells.forEach(c => c.disabled = !myTurn);
      resetBtn.disabled = !provider || !provider.connected;
    }

    // ===== Buttons =====
    joinBtn.onclick = () => {
      const room = roomInput.value.trim();
      if (!room) { alert('Enter a room name first.'); return; }
      joinBtn.disabled = true; roomInput.disabled = true; secretInput.disabled = true; leaveBtn.disabled = false;
      initDoc(room, secretInput.value.trim());
    };

    leaveBtn.onclick = () => {
      try { provider && provider.destroy(); } catch {}
      try { ydoc && ydoc.destroy(); } catch {}
      location.reload();
    };

    resetBtn.onclick = () => reset();

    // Auto-fill a friendly room if URL hash is present
    const hashRoom = location.hash.replace('#','');
    if (hashRoom) roomInput.value = hashRoom;

    // Initial render
    render();
  </script>
</body>
</html>